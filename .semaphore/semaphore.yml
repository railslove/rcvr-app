version: v1.0
name: rcvr ci
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

global_job_config:
  prologue:
    commands:
      - sem-version node 12

blocks:
  - name: 'Install'
    dependencies: []
    task:
      jobs:
        - name: npm install
          commands:
            - checkout
            - cache restore
            - npm ci
            - npm run cypress verify
            - cache store

  - name: 'Test'
    dependencies: ['Install']
    task:
      prologue:
        commands:
          - checkout --use-cache
          - cache restore
          - npm run dev &
      jobs:
        - name: cypress
          commands:
            - npm test

      epilogue:
        on_fail:
          commands:
            - artifact push job cypress/videos
            - artifact push job cypress/screenshots

  - name: 'Analyze'
    dependencies: ['Install']
    task:
      prologue:
        commands:
          - checkout --use-cache
          - cache restore
      jobs:
        - name: lint
          commands:
            - npm run lint
        - name: typecheck
          commands:
            - npm run typecheck
